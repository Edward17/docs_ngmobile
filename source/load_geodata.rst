.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _load_geodata:

Загрузка данных
===============

GeoJSON
-------

При загрузке из формата :term:GeoJSON в файле должна быть хотя бы одна запись. 

:term:Система координат геометрий может быть WGS 84 (EPSG:4326) или Web Mercator (EPSG:3857), если на вход будет подан файл в другой системе координат, то будет выведено сообщение, о том, что такая система координат не поддерживается. 

Геометрия в файле должна быть одного типа. Если во входном файле содержаться геометрии разного типа, то будут загружены записи, у которых тип геометрии совпадает с первой записью (геометрия первой записи файла определяет тип геометрии слоя).

Текстовые строки должны быть кодированы в формате UTF-8. 

.. note::
   Подробнее о формате GeoJSON можно прочитать в его `спецификации <http://geojson.org/>`_. GeoJSON основывается на формате JSON (см. `RFC 4627 <https://www.ietf.org/rfc/rfc4627.txt>`_).

Тайловый кэш
------------

Тайловый кэш представляет собой архив формата zip в котором упакованы папки и тайлы в соответствии с нарезкой (например, folder_z/folder_x/y.png). Сами папки уровня Z могут находится в корне архива или в одной папке в корне архива (название папки может быть любым). Более глубокая вложенность не допускается. 

Тайловый кэш может быть получен при помощи модуля расширения NextGIS QGIS - QTiles. Полученный в результате работы модуля архив можно загрузить на устройство в любую доступную папку.


Настраиваемые формы
-------------------

Файл формата ngfb получается в результате работы программы NextGIS FormBuilder и представляет собой :term:`GeoJSON` файл с дополнительной информацией, которые упакованы в архив zip, но расширением ngfb.


Подключение тайлового сервиса
-----------------------------
 
При выборе пункта меню "веб" (см. :numref:`main_activity_pic` п. 3) открывается диалоговое окно представленное на :numref:`add_tms_pic`.

.. figure:: _static/ngmobile_addtms.png
   :name: add_tms_pic
   :align: center
   :scale: 55 %
   
   Диалог подключения тайлового источника геоданных.
   
   Цифрами обозначено: 1 - название нового слоя; 2 - адрес тайлов слоя; 3 - тип тайлового сервиса; 4 - логин; 5 - пароль; 6 - кнопка создания слоя; 7 - кнопка отмены.
   
При формировании адреса сервиса тайлов необходимо указать место в адресе значений X (номер тайла по горизонтали), Y (номер тайла по вертикали) и Z (уровень зума). Для этого в строке адреса на месте цифры соответствующей Х необходимо поставить подстановочный код **{x}**, для Y - **{y}**, для Z - **{z}**. Дополнительно в строке адреса можно указать поддомены (например, для поддоменов a.tileopenstreetmap.org, b.tileopenstreetmap.org, c.tileopenstreetmap.org адрес будет выглядеть так: **{a,b,c}.tile.openstreetmap.org**).

.. note::

   При загрузке тайлов на каждый адрес (поддомен) приложение осуществляет запрос в два потока. Таким образом для адреса {a,b,c}.tile.openstreetmap.org приложение будет скачивать тайлы в 6 потоков.
   
Все полученные из сети Интернет/Интранет тайлы кэшируются на карте памяти. При запросе конкретного тайла, вначале проверяется локальный кэш. Если в локальном кэше есть тайл и его время создания менее семи дней, то на карту будет выведен он. Также кэшированный тайл будет выведен при отсутствии подключения к сети Интернет/Интранет или если в ходе загрузи был сбой. Полученный из сети Интернет/Интранет тайл перекрывает имеющийся в кэше.

В списке выбора типа тайлового слоя (см. :numref:`add_tms_pic`, п. 3) имеется следующий выбор:

* XYZ (OSM) - стандартный тип тайлового сервиса;
* TMS (OSGeo) - в соответствии со стандартом OSGeo.

Если для доступа к тайлам необходима аутентификация, то можно указать логин и пароль.

.. note::

   Поддерживается только `Basic access authentication <http://en.wikipedia.org/wiki/Basic_access_authentication>`_. 
